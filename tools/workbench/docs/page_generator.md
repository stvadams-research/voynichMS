# Page Generator

## Scope

The workbench `Page Generator` creates folio-conditioned synthetic lines using:

1. lattice transitions (`lattice_map` + `window_contents`),
2. Phase 18 schedule offsets per line,
3. observed or sampled line-count policy,
4. optional strict canonical lowercase filtering.

It is a structural generation tool, not a folio reconstruction claim.

## Data Contracts

The page generator consumes two bundled artifacts:

1. `tools/workbench/data/page_schedule_data.js` (`window.WORKBENCH_PAGE_SCHEDULE`)
2. `tools/workbench/data/page_priors_data.js` (`window.WORKBENCH_PAGE_PRIORS`)

Both are generated by:

```bash
python scripts/phase18_generate/build_page_generation_assets.py
python scripts/tools/build_workbench_bundle.py
```

### Schedule schema (v1)

Source: `results/data/phase18_generate/folio_state_schedule.json`

Required keys:

1. `schema_version = "phase18_folio_schedule_v1"`
2. `global_mode_offset` (int)
3. `section_mode_offsets` (dict)
4. `folios` (list)
5. `summary` (dict)

Each folio entry contains:

1. `folio`
2. `section`
3. `hand`
4. `line_count`
5. `lines[]` with:
   - `line_index`
   - `marker`
   - `offset`
   - `source`

### Priors schema (v1)

Source: `results/data/phase18_generate/page_priors.json`

Required keys:

1. `schema_version = "phase18_page_priors_v1"`
2. `line_count_priors`
3. `marker_priors`
4. `observed_folios`
5. `summary`

## Fallback Semantics

Offset resolution (`schedule_mode=auto`) is deterministic:

1. line-level inferred offset,
2. folio mode offset,
3. section mode offset,
4. global mode offset.

Line-count resolution:

1. `observed` mode: exact folio line count from `folio_data.js`.
2. `sampled` mode: section/side/global prior sampling with deterministic seed.
3. fallback to observed count if priors are unavailable.

All fallback paths are surfaced in the diagnostics panel and internal console.

## Validator Integration

`Generate -> Validate` sends output directly to `IVTFF Validator` in `lattice` mode with strict canonical policy enabled.

## Known Limits

1. Schedule quality is bounded by existing Phase 14 mask inference data.
2. Folios without line-level inferred data use section/global fallback.
3. Multi-source transliteration bridge rendering is not part of this phase.
