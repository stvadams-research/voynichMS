<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voynich Slip Explorer</title>
    <style>
        /* Existing styles */
        body { font-family: sans-serif; background: #f4f4f9; color: #333; margin: 0; display: flex; height: 100vh; }
        #sidebar { width: 300px; background: #fff; border-right: 1px solid #ddd; overflow-y: auto; padding: 20px; }
        #main { flex: 1; padding: 40px; overflow-y: auto; }
        .tabs { margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab { display: inline-block; padding: 10px 20px; cursor: pointer; border: 1px solid transparent; margin-bottom: -2px; }
        .tab.active { border: 2px solid #ddd; border-bottom: 2px solid #f4f4f9; background: #f4f4f9; font-weight: bold; }
        .slip-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        /* ... */
        .volvelle-slot { display: inline-block; width: 120px; padding: 10px; border: 1px solid #ccc; text-align: center; margin: 5px; background: #eee; }
        .volvelle-slot.active { background: #fff; border: 2px solid #4a4ae2; font-weight: bold; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Demonstration</h2>
    <div class="tabs">
        <div class="tab active" onclick="switchTab('slips')">Slips</div>
        <div class="tab" onclick="switchTab('sandbox')">Engine</div>
    </div>
    
    <div id="slip-pane">
        <p class="summary">Total: 914 signal-verified events.</p>
        <div id="slip-list"></div>
    </div>
    
    <div id="sandbox-pane" style="display:none;">
        <p class="summary">Virtual Voynich Engine (3-State Volvelle)</p>
        <label>Rotation Setting:</label>
        <input type="range" min="0" max="9" value="0" id="mask-slider" oninput="updateSandbox()">
        <p>Rotate the wheel to change the 'Thematic Mask'.</p>
    </div>
</div>

<div id="main">
    <div id="slips-view">
        <div id="welcome">
            <h1>Voynich Slip Explorer</h1>
            <p>Select a slip from the sidebar to visualize the mechanical misalignment.</p>
        </div>
        <div id="viz" style="display:none;">
            <!-- Existing viz content -->
            <div class="line-container">
                <span class="label">Source Line (Previous Context)</span>
                <div id="prev-line-text"></div>
            </div>
            <div class="line-container">
                <span class="label">Slipped Line (Current)</span>
                <div id="curr-line-text"></div>
            </div>
            <p><strong>Line Index:</strong> <span id="stat-line"></span> | <strong>Position:</strong> <span id="stat-pos"></span></p>
        </div>
    </div>

    <div id="sandbox-view" style="display:none;">
        <h1>Mechanical Sandbox</h1>
        <p>This replicates the physical process of selecting tokens through a three-state window.</p>
        <div id="engine-display">
            <div class="line-container">
                <span class="label">Current Tool Windows (Positions 1-5)</span>
                <div id="windows-grid"></div>
            </div>
            <div class="line-container">
                <span class="label">Generated Sequence</span>
                <div id="gen-output" style="font-family:monospace; font-size:1.5em; color: #4a4ae2;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let slips = [];
    let blueprint = [];

    async function loadData() {
        const sRes = await fetch('../../results/data/phase13_demonstration/slip_viz_data.json');
        const sData = await sRes.json();
        slips = sData.slips;
        renderList();

        const bRes = await fetch('../../results/data/phase12_mechanical/physical_blueprint.json');
        const bData = await bRes.json();
        blueprint = bData.results.blueprint;
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        
        if (tab === 'slips') {
            document.getElementById('slip-pane').style.display = 'block';
            document.getElementById('sandbox-pane').style.display = 'none';
            document.getElementById('slips-view').style.display = 'block';
            document.getElementById('sandbox-view').style.display = 'none';
        } else {
            document.getElementById('slip-pane').style.display = 'none';
            document.getElementById('sandbox-pane').style.display = 'block';
            document.getElementById('slips-view').style.display = 'none';
            document.getElementById('sandbox-view').style.display = 'block';
            updateSandbox();
        }
    }

    function updateSandbox() {
        const offset = parseInt(document.getElementById('mask-slider').value);
        const grid = document.getElementById('windows-grid');
        const output = document.getElementById('gen-output');
        grid.innerHTML = '';
        
        let genWords = [];
        for (let p = 0; p < 5; p++) {
            const word = blueprint[offset][p];
            genWords.push(word);
            const div = document.createElement('div');
            div.className = 'volvelle-slot active';
            div.innerHTML = `<span class="label">Pos ${p+1}</span>${word}`;
            grid.appendChild(div);
        }
        output.innerText = genWords.join(' ');
    }

    function renderList() {
        const list = document.getElementById('slip-list');
        slips.forEach((s, idx) => {
            const div = document.createElement('div');
            div.className = 'slip-item';
            div.innerHTML = `Line ${s.line_no}: <strong>${s.word}</strong>`;
            div.onclick = () => showSlip(idx, div);
            list.appendChild(div);
        });
    }

    function showSlip(idx, element) {
        document.getElementById('welcome').style.display = 'none';
        document.getElementById('viz').style.display = 'block';
        document.querySelectorAll('.slip-item').forEach(i => i.classList.remove('active'));
        element.classList.add('active');
        const s = slips[idx];
        
        const prevDiv = document.getElementById('prev-line-text');
        prevDiv.innerHTML = '';
        s.previous_line.forEach((t, i) => {
            const span = document.createElement('span');
            span.className = 'token' + (i === s.token_pos - 1 ? ' source' : '');
            span.innerText = t;
            prevDiv.appendChild(span);
        });
        
        const currDiv = document.getElementById('curr-line-text');
        currDiv.innerHTML = '';
        s.current_line.forEach((t, i) => {
            const span = document.createElement('span');
            span.className = 'token' + (i === s.token_pos ? ' highlight' : '');
            span.innerText = t;
            currDiv.appendChild(span);
        });
        
        document.getElementById('stat-line').innerText = s.line_no;
        document.getElementById('stat-pos').innerText = s.token_pos;
    }

    loadData();
</script>

</body>
</html>
