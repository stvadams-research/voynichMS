<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Voynich Machine Explorer</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; color: #1c1e21; margin: 0; display: flex; height: 100vh; }
        #sidebar { width: 380px; background: #ffffff; border-right: 1px solid #ddd; display: flex; flex-direction: column; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        #main { flex: 1; padding: 40px; overflow-y: auto; background: #f0f2f5; }
        
        .header { padding: 20px; border-bottom: 1px solid #eee; }
        .tabs { display: flex; padding: 0 20px; border-bottom: 1px solid #eee; background: #fafafa; }
        .tab { padding: 12px 0; flex: 1; text-align: center; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; color: #65676b; transition: all 0.2s; }
        .tab.active { border-bottom-color: #1877f2; color: #1877f2; }
        
        .scroll-area { flex: 1; overflow-y: auto; padding: 20px; }
        .upload-card { background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.85em; }
        
        .item-card { padding: 12px; border-radius: 6px; border: 1px solid #eee; margin-bottom: 8px; cursor: pointer; transition: background 0.2s; background: #fff; }
        .item-card:hover { background: #f2f2f2; }
        .item-card.active { border-left: 5px solid #1877f2; background: #e7f3ff; }
        
        .display-box { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 30px; }
        .token { display: inline-block; padding: 6px 12px; margin: 4px; border-radius: 6px; font-family: 'Courier New', Courier, monospace; font-size: 1.3em; background: #f0f2f5; }
        .token.highlight { background: #ffe9e9; color: #d93025; border: 1px solid #f28b82; font-weight: bold; }
        .token.source { background: #e6f4ea; color: #188038; border: 1px solid #81c995; font-weight: bold; }
        
        .engine-word { display: inline-block; min-width: 120px; padding: 12px; margin: 6px; background: #fff; border: 2px solid #1877f2; border-radius: 8px; text-align: center; cursor: pointer; font-family: monospace; font-weight: bold; transition: transform 0.1s, background 0.2s; position: relative; }
        .engine-word:hover { transform: translateY(-2px); background: #f0f7ff; }
        .engine-word:active { transform: translateY(0); }
        .engine-word .next-tip { display: block; font-size: 0.7em; color: #65676b; font-weight: normal; margin-top: 4px; }
        .engine-word .badge { position: absolute; top: -8px; right: -8px; background: #1877f2; color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 0.7em; line-height: 24px; }
        
        #output-stream { font-family: monospace; font-size: 2.2em; color: #1c1e21; padding: 20px; border-top: 2px solid #eee; margin-top: 20px; min-height: 1.5em; word-wrap: break-word; }
        .label { font-size: 0.75em; text-transform: uppercase; color: #8e8e8e; letter-spacing: 1px; font-weight: bold; margin-bottom: 10px; display: block; }
        
        #console { background: #1c1e21; color: #00ff00; padding: 15px; font-family: 'Consolas', monospace; font-size: 0.8em; border-radius: 8px; height: 120px; overflow-y: auto; margin-top: 20px; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="header">
        <h2 style="margin:0">Voynich Artifact</h2>
        <p style="font-size:0.8em; color:#65676b">Mechanical Identity Reconstruction</p>
    </div>
    
    <div class="tabs">
        <div id="btn-tab-slips" class="tab active" onclick="setTab('slips')">SLIPS</div>
        <div id="btn-tab-lattice" class="tab" onclick="setTab('lattice')">LATTICE</div>
    </div>
    
    <div id="pane-slips" class="scroll-area">
        <div class="upload-card">
            <strong>1. Load <code>slip_viz_data.json</code></strong>
            <input type="file" onchange="handleFile(this, 'slips')" style="margin-top:10px; width:100%">
        </div>
        <div id="list-slips"></div>
    </div>
    
    <div id="pane-lattice" class="scroll-area" style="display:none">
        <div class="upload-card">
            <strong>2. Load <code>full_palette_grid.json</code></strong>
            <input type="file" onchange="handleFile(this, 'grid')" style="margin-top:10px; width:100%">
        </div>
        <div id="list-windows"></div>
    </div>
    
    <div style="padding:20px; border-top:1px solid #eee">
        <div class="label">Internal Debugger</div>
        <div id="console">System ready.</div>
    </div>
</div>

<div id="main">
    <div id="view-slips">
        <h1>Scribal Slip Explorer</h1>
        <div id="welcome-slips"><p>Please upload the mechanical slip data to visualize vertical offsets.</p></div>
        <div id="viz-slips" style="display:none">
            <div class="display-box">
                <span class="label">Line N-1 (The Source)</span>
                <div id="row-prev"></div>
            </div>
            <div class="display-box">
                <span class="label">Line N (The Slipped Output)</span>
                <div id="row-curr"></div>
            </div>
            <div class="display-box" style="background:#e7f3ff; border:1px solid #1877f2">
                <p><strong>Proof:</strong> The scribe's eye slipped to the window used in the previous line. The resulting word is mathematically impossible for the current line's context, but 100% legal for the line above.</p>
            </div>
        </div>
    </div>

    <div id="view-lattice" style="display:none">
        <h1>Mechanical Sandbox</h1>
        <p>This replicates the physical process of selecting tokens. The chosen word advances the machine to its next window.</p>
        <div style="margin-bottom:20px">
            <button onclick="clearOutput()" style="padding:10px 20px; cursor:pointer; background:#1877f2; color:#fff; border:none; border-radius:6px; font-weight:bold; margin-right:10px">Reset Machine</button>
            <button onclick="randomJump()" style="padding:10px 20px; cursor:pointer; background:#e4e6eb; color:#000; border:none; border-radius:6px; font-weight:bold">Random Jump</button>
        </div>
        
        <div class="display-box" style="margin-top:20px">
            <span class="label">Available Tokens in Window <span id="cur-win-num" style="color:#1877f2">0</span></span>
            <div id="engine-grid"></div>
        </div>
        
        <div class="display-box">
            <span class="label">Physical Output (Generative Trace)</span>
            <div id="output-stream"></div>
        </div>
    </div>
</div>

<script>
    const app = {
        slips: [],
        grid: null,
        currentWindow: "0",
        activeTab: 'slips'
    };

    function msg(text) {
        const c = document.getElementById('console');
        c.innerHTML += `<div>&gt; ${text}</div>`;
        c.scrollTop = c.scrollHeight;
    }

    function setTab(name) {
        app.activeTab = name;
        document.getElementById('btn-tab-slips').className = 'tab' + (name==='slips'?' active':'');
        document.getElementById('btn-tab-lattice').className = 'tab' + (name==='lattice'?' active':'');
        document.getElementById('pane-slips').style.display = (name==='slips'?'block':'none');
        document.getElementById('pane-lattice').style.display = (name==='lattice'?'block':'none');
        document.getElementById('view-slips').style.display = (name==='slips'?'block':'none');
        document.getElementById('view-lattice').style.display = (name==='lattice'?'block':'none');
        if(name === 'lattice' && app.grid) renderLattice();
    }

    function handleFile(input, type) {
        if(!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if(type === 'slips') {
                    app.slips = data.slips || [];
                    msg(`Loaded ${app.slips.length} slips.`);
                    renderSlipSidebar();
                } else {
                    app.grid = data.results || data;
                    msg(`Loaded grid with ${Object.keys(app.grid.window_contents).length} windows.`);
                    renderWindowSidebar();
                    renderLattice();
                }
            } catch(err) { msg("Error parsing JSON: " + err.message); }
        };
        reader.readAsText(input.files[0]);
    }

    function renderSlipSidebar() {
        const container = document.getElementById('list-slips');
        container.innerHTML = '';
        app.slips.slice(0, 50).forEach((s, idx) => {
            const div = document.createElement('div');
            div.className = 'item-card';
            div.innerHTML = `<strong>Line ${s.line_no}</strong>: ${s.word}`;
            div.onclick = () => {
                document.querySelectorAll('#list-slips .item-card').forEach(c=>c.classList.remove('active'));
                div.classList.add('active');
                showSlip(s);
            };
            container.appendChild(div);
        });
    }

    function showSlip(s) {
        document.getElementById('welcome-slips').style.display = 'none';
        document.getElementById('viz-slips').style.display = 'block';
        
        const renderRow = (id, tokens, targetIdx, cls) => {
            const el = document.getElementById(id);
            el.innerHTML = '';
            tokens.forEach((t, i) => {
                const span = document.createElement('span');
                span.className = 'token' + (i === targetIdx ? ' ' + cls : '');
                span.innerText = t;
                el.appendChild(span);
            });
        };
        renderRow('row-prev', s.previous_line, s.token_pos - 1, 'source');
        renderRow('row-curr', s.current_line, s.token_pos, 'highlight');
    }

    function renderWindowSidebar() {
        const container = document.getElementById('list-windows');
        container.innerHTML = '';
        const keys = Object.keys(app.grid.window_contents).sort((a,b) => parseInt(a) - parseInt(b));
        keys.forEach(k => {
            const div = document.createElement('div');
            div.className = 'item-card' + (app.currentWindow === k ? ' active' : '');
            div.id = `win-card-${k}`;
            div.innerText = `Window ${k}`;
            div.onclick = () => {
                app.currentWindow = k.toString();
                renderLattice();
            };
            container.appendChild(div);
        });
    }

    function renderLattice() {
        if(!app.grid) return;
        const winId = app.currentWindow;
        document.getElementById('cur-win-num').innerText = winId;
        
        // Update Sidebar
        document.querySelectorAll('#list-windows .item-card').forEach(c=>c.classList.remove('active'));
        const activeCard = document.getElementById(`win-card-${winId}`);
        if(activeCard) {
            activeCard.classList.add('active');
            activeCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        const grid = document.getElementById('engine-grid');
        grid.innerHTML = '';
        
        const words = app.grid.window_contents[winId] || [];
        // Only show top 24 words to keep UI clean
        words.slice(0, 24).forEach(word => {
            const nextWin = app.grid.lattice_map[word];
            const div = document.createElement('div');
            div.className = 'engine-word';
            // Show the next window ID as a badge
            div.innerHTML = `${word} <div class="badge">${nextWin ?? '?'}</div>`;
            
            div.onclick = () => {
                msg(`Selecting "${word}"...`);
                document.getElementById('output-stream').innerText += (document.getElementById('output-stream').innerText ? ' ' : '') + word;
                
                if (nextWin !== undefined) {
                    msg(`Advancing to Window ${nextWin}`);
                    app.currentWindow = nextWin.toString();
                    // Use timeout to ensure UI updates
                    setTimeout(renderLattice, 50);
                } else {
                    msg(`No transition found for "${word}". Staying in Window ${winId}`);
                }
            };
            grid.appendChild(div);
        });
    }

    function clearOutput() {
        document.getElementById('output-stream').innerText = '';
        app.currentWindow = "0";
        renderLattice();
        msg("Machine Reset to Window 0.");
    }

    function randomJump() {
        if(!app.grid) return;
        const keys = Object.keys(app.grid.window_contents);
        const randKey = keys[Math.floor(Math.random() * keys.length)];
        app.currentWindow = randKey;
        renderLattice();
        msg(`Random jump to Window ${randKey}`);
    }
</script>

</body>
</html>
